# ハンズオンワークショップ前の事前準備
このハンズオントレーニングでは、各参加者に以下のことをしていただきます。
- Azure Storage アカウントの作成
- Azure AI Search アカウントの作成
- Azure AI Foundry - Hub の作成
- Azure AI Foundry - Project の作成
- Azure AI Search アカウントに対して Azure Storage アカウントへアクセスするための権限を付与
- Azure AI Search アカウントに対して Azure AI Services アカウントへアクセスするための権限を付与
- Azure Web Apps リソースに対して Azure AI Project へアクセスするための権限を付与

Azure リソースのシステム割り当てマネージドIDに対して権限付与(ロールの割り当て)を行う必要があるため、参加者には、使用する Azure サブスクリプション、またはリソースグループレベルでの```所有者```ロールの付与が必要です。また、参加者全員が Azure AI Foundry で Azure OpenAI Service の ```gpt-4o``` または ```gpt-4o-mini``` と ```text-embeddings-3-large``` のモデルを必要クォータ数(TPM)だけデプロイする必要があるため、使用する Azure サブスクリプションにその合計クォータ数(合計割り当て可能 TPM)が [参加者数] × [参加者１人あたりが使用するTPM] 以上であることを確認する必要があります。そして、使用する Azure サブスクリプションが上記の Azure リソースをデプロイすることを許可されている必要があります。

以下に、以下を実施するための方法の説明を記述します。
- 参加者の Entra アカウントを、トレーニングに使用する Azure サブスクリプションが所属する Microsoft Entra テナント に所属していることを確認し、必要に応じて招待する
- リソースグループを作成して、参加者の Entra アカウントに、作成したリソースグループに対する```所有者```ロールを付与する
- トレーニングに使用する Azure サブスクリプションに割り当てられている Azure OpenAI Service モデル(```gpt-4o```, ```gpt-4o-mini```, ```text-embeddings-3-large```)のクォータ(TPM)を確認する。
- 使用する Azure サブスクリプションにて今回使用する Azure サービスをデプロイ可能とするためのリソースプロバイダの設定  


## 参加者の Entra アカウントがテナントに属するかの確認
サブスクリプションを含む、Azure のリソースに対するアクセス権限を付与するためには、その対象者の Entra アカウントが Azure サブスクリプションが所属する Microsoft Entra テナントに所属しておく必要があります。まず、参加者の Entra アカウントが当該テナントに所属しているかを確認するために、[Microsoft Azure Portal](https://portal.azure.com/) へアクセスします。そして、サイドメニューの```[全てのサービス]```をクリックします。

### 参加者の Entra アカウントがテナントに属するかの確認

![参加者の Entra アカウントがテナントに属するかの確認1](images/0.preparation/1.png)

表示されたウィンドウのサイドメニューのカテゴリ内にある ```[ID]``` をクリックし、表示された ID 関係の Azure サービスの中にある、```Microsoft Entra ID``` のエリアにある```[表示]```をクリックします。

![参加者の Entra アカウントがテナントに属するかの確認2](images/0.preparation/2.png)

現在選択中の Entra テナントの設定画面が表示されます。サイドメニューの```[管理]>[ユーザ]```クリックします。

![参加者の Entra アカウントがテナントに属するかの確認3](images/0.preparation/3.png)

Entra テナントに所属しているユーザ一覧が表示されます。ここで、今回の参加者の Entra ユーザがテナントに所属していることを確認します。

![参加者の Entra アカウントがテナントに属するかの確認4](images/0.preparation/4.png)

### 参加者の Entra アカウントのテナントへの招待

もし参加者の Entra ユーザがテナントに所属していない場合、テナントに招待する必要があります。上部メニューの```[＋新しいユーザ]```をクリックし、```[外部ユーザの招待]```をクリックします。

![参加者の Entra アカウントのテナントへの招待1](images/0.preparation/5.png)

参加者の```[Entra ユーザ名(メールアドレス)]```を入力し、必要に応じて[表示名]を入力し、```[レビューと招待]```ボタンをクリックします。

![参加者の Entra アカウントのテナントへの招待2](images/0.preparation/6.png)

```[招待]```ボタンをクリックすると、参加者のメールアドレスに招待メールが送信されます。メールのタイトルは```"XXXXX(テナント名) invited you to access applications within their organization"``` といった内容で、参加者はメール中にある ```[Accept invitation]``` をクリックすることで、招待を承諾する必要があります。

![参加者の Entra アカウントのテナントへの招待3](images/0.preparation/7.png)

## リソースグループの作成と所有者権限の付与
続いて、参加者用のリソースグループを作成して、参加者の Entra アカウントに対して、リソースグループへの所有者ロールを付与します。リソースグループは参加者ごとに作成されることを想定していますが、1つのリソースグループを複数の参加者で共有することも可能です。  
まず、[Azure Portal](https://portal.azure.com/) のサイドメニューの```[全てのサービス]```をクリックします。

### リソースグループの作成

![リソースグループの作成1](images/0.preparation/8.png)

表示されたウィンドウのサイドメニューのカテゴリ内にある ```全般``` をクリックし、表示された Azure サービスの中にある、```リソースグループ``` のエリアにある```[作成]```をクリックします。

![リソースグループの作成2](images/0.preparation/9.png)

リソースグループ作成のページが表示されます。まず```[サブスクリプション]```が今回使用するサブスクリプションが選択されていることを確認し、```[リソースグループ名]```を入力します。[リージョン]はどのリージョンでも構いません。入力を終えたら、```[確認と作成]```ボタンをクリックします。

> リソースグループ内の Azure リソースのリージョンは、リソースグループのリージョンと同一でなければならない、というルールはありません。Japan East リージョンのリソースグループ内に、East US リージョンの Azure Storage アカウントを作成することもできます。リソースグループのリージョンは、グループ内のリソース一覧を表示する際に、どのリージョンの Azure REST API を呼び出すの違いしかないため、どのリージョンを選択しても大きな問題になることはありません。

![リソースグループの作成3](images/0.preparation/10.png)

作成するリソースグループの確認を行います。内容を確認したら、```[作成]```ボタンをクリックし、リソースグループの作成を開始します。

![リソースグループの作成4](images/0.preparation/11.png)

### リソースグループへの所有者権限の付与

リソースグループの作成が完了すると、画面右上に以下のようなホップアップが表示されるため、```[リソースグループの表示]```ボタンをクリックします。

![リソースグループへの所有者権限の付与1](images/0.preparation/12.png)

作成したリソースグループのページが表示されます。ここでは、リソースグループ内の Azure リソースの一覧を閲覧することができます。サイドメニューの```[アクセス制御(IAM)]```をクリックすると、リソースグループに対するアクセス権限付与に関するページが表示されます。このページの上部メニューの```[＋追加]```をクリックし、```[ロールの割り当ての追加]```をクリックします。

![リソースグループへの所有者権限の付与2](images/0.preparation/13.png)

ロールの割り当て追加の画面が表示されます。まず付与するロールを選択します。タブ```[特権管理者ロール]```をクリック、```[所有者]```をクリックして、```[次へ]```ボタンをクリックします。

![リソースグループへの所有者権限の付与3](images/0.preparation/14.png)

次に、ロールの付与先を選択します。```[ユーザ、グループ、またはサービスプリンシパル]```をチェックし、[＋メンバーを選択]をクリックします。右側に表示されたウィンドウにて、付与対象の Entra アカウントを選択します。複数人を同時に選択することもできます。アカウントを選択したら、```[選択]```ボタンをクリックします。

![リソースグループへの所有者権限の付与4](images/0.preparation/15.png)

ロールの付与先の確認を行い、```[次へ]```ボタンをクリックします。

![リソースグループへの所有者権限の付与5](images/0.preparation/16.png)

ロール割り当ての条件を設定します。所有者ロールは非常に強い権限を持つロールであるため、権限を限定的するため、[ユーザができること]として```[特権管理者ロールである所有者、UAA、RBAC　を覗くすべてのロールを割り当てることをユーザに許可します (おすすめ)]``` をチェックし、```[レビューと割り当て]```ボタンをクリックします。これは、対象アカウントが作成した Azure リソースに対するロール付与はできるけど、他のアカウントに対してリソースグループに対する権限付与はできなくするための制御です。

![リソースグループへの所有者権限の付与6](images/0.preparation/17.png)

ロールの割り当て内容の確認を行い、```[レビューと割り当て]```ボタンをクリックします。これで、割り当て対象の Entra ユーザは、このリソースグループにアクセスすることができ、かつこのリソースグループにデプロイした Azure リソースに対するロールの割り当てを自由に行えるようになりました。

![リソースグループへの所有者権限の付与7](images/0.preparation/18.png)


## Azure サブスクリプションの Azure OpenAI Service のモデルクォータの確認

[https://ai.azure.com/managementCenter/quota](https://ai.azure.com/managementCenter/quota) にアクセスし、トレーニングで使用する Azure サブスクリプションにアクセスすることができる Microsoft Entra アカウントでログインします。   
すると、以下のような Azure AI Foundry の 管理センターが表示されます。
![Azure OpenAI Service のモデルクォータの確認](images/0.preparation/19.png)

画面右上のログインユーザのアイコンをクリックし、ワークショップに使用する Azure サブスクリプションが所属する Entra テナントが選択されていることを確認します。もし、異なる Entra テナントの名前が表示されている場合は、```[ディレクトリの切り替え]``` リンクをクリックして、使用する Entra テナントを選択します。
![Azure OpenAI Service のモデルクォータの確認](images/0.preparation/20.png)

Entra ディレクトリの選択を行ったら、次に、```[サブスクリプション]``` に ```"今回使用する Azure サブスクリプション"``` を指定します。 
![Azure OpenAI Service のモデルクォータの確認](images/0.preparation/21.png)

```[Azure OpenAI Service Standard + バッチ]``` のタブが選択されていると思います。タブ内に表示されているテーブルのうち、```[GlobalStandard]``` のツリーを左側の ```[＞]``` をクリックして開いて、また ```[gpt-4o]``` と ```[gpt-4o-mini]``` の項目も同様に開きます。すると、```gpt-4o``` モデルと ```gpt-4o-mini``` モデルの当該 Azure サブスクリプションに割り当てられた各モデルのクォータ(TPM: Token Per Minutes) がモデル名の右側に表示されます。以下の例は、```gpt-4o``` が 450K TPM が Azure サブスクリプションで割り当てられる合計 TPM であり、450K TPM が割り当て済みです。```gpt-4o-mini``` も同様に、2M TPM 中 2M TPM が割り当て済みの状態です。今回のワークショップでは、```gpt-4o``` と ```gpt-4o-mini``` の合計割り当て可能 TPM が ```[参加人数]``` × 40K の以上である必要があります。
![Azure OpenAI Service のモデルクォータの確認](images/0.preparation/22.png)
  
同様の方法で、```text-embeddings-3-large``` の合計割り当て可能 TPM を確認し、その値が ```[参加人数]``` × 40K の以上である必要であることを確認します。

## Azure サブスクリプションのリソースプロバイダの設定
今回のトレーニングでは、使用する Azure サブスクリプションが上記の Azure リソースをデプロイすることを許可されている必要があります。Azure リソースのデプロイ許可は、[リソースプロバイダー](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-providers-and-types)という機能で設定します。  

まず、[Microsoft Azure Portal](https://portal.azure.com/) のサイドメニューの```[全てのサービス]```をクリックします。続いて、表示されたウィンドウのサイドメニューのカテゴリ内にある ```[全般]``` をクリックし、表示された機能の中にある、```サブスクリプション``` のエリアにある```[表示]```をクリックします。
![Azure サブスクリプションのリソースプロバイダの設定](images/0.preparation/22.png)

ログインしている Entra ユーザが閲覧可能な Azure サブスクリプション一覧が表示されます。この画面で、今回のトレーニングで使用する Azure サブスクリプションの名前をクリックします。
![Azure サブスクリプションのリソースプロバイダの設定](images/0.preparation/23.png)

クリックした Azure サブスクリプションの詳細ページが表示されます。サイドメニューの ```[設定]``` カテゴリ内の ```[リソースプロバイダ]``` をクリックすると、各プロバイダの名前と状態(```NotRegistered``` または ```Registered```)が表示されます。
![Azure サブスクリプションのリソースプロバイダの設定](images/0.preparation/24.png)

以下のプロバイダーについて、状態を ```Registered``` にする必要があります。ページ上部の検索ボックスにてプロバイダー名を入力し、表示されたプロバイダーの```状態```を確認し、もし ```NotRegistered``` の場合は、プロバイダー名の左にあるラジオボタンをクリックし、ページ上部の ```[登録]``` ボタンをクリックすることで、当該プロバイダー(Azure リソース)を利用可能とさせます。
 - Microsoft.Storage
 - Microsoft.Search
 - Microsoft.MachineLearningServices
 - Microsoft.CognitiveServices
 - Microsoft.KeyVault
 - microsoft.insights
 - Microsoft.OperationalInsights
 - Microsoft.ContainerRegistry
 - Microsoft.Web
 ![Azure サブスクリプションのリソースプロバイダの設定](images/0.preparation/25.png)
